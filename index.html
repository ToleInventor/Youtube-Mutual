<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube Exchange</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root {
      --youtube-red: #FF0000;
      --youtube-dark: #282828;
      --youtube-light: #F9F9F9;
    }
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: var(--youtube-light);
    }
    h1 {
      color: var(--youtube-red);
      text-align: center;
    }
    .box {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button {
      background: var(--youtube-red);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    .channel {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #dashboard, #channel-form {
      display: none;
    }
    .pending {
      opacity: 0.6;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>YouTube Exchange</h1>

    <div id="auth-section" class="box">
      <h2>Get Started</h2>
      <p>Sign in to register your channel</p>
      <div id="g_id_onload"
           data-client_id="55873258958-126c00b3kq0cjsgeciimqtcieoin8915.apps.googleusercontent.com"
           data-callback="handleLogin">
      </div>
      <div class="g_id_signin"
           data-type="standard"
           data-size="large">
      </div>
    </div>

    <div id="channel-form" class="box">
      <h2>Register Your Channel</h2>
      <p>Enter your YouTube channel URL:</p>
      <input type="text" id="channel-url" placeholder="https://youtube.com/c/YourChannel">
      <button onclick="registerChannel()">Register</button>
    </div>

    <div id="dashboard" class="box">
      <h2>Welcome, <span id="username"></span>!</h2>
      <p>Your channel: <span id="user-channel"></span></p>
      
      <h3>Available Channels</h3>
      <div id="channels-list">
        <!-- Channels will appear here -->
      </div>

      <h3>Pending Exchanges</h3>
      <div id="pending-list">
        <!-- Pending exchanges will appear here -->
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const REPO = 'ToleInventor/Youtube-Mutual';
    const DATA_URL = `https://raw.githubusercontent.com/${REPO}/main/data.json`;
    
    // Global variables
    let currentUser = null;
    let allChannels = [];
    let pendingExchanges = [];

    // Load initial data
    async function loadData() {
      try {
        const response = await fetch(DATA_URL + '?t=' + Date.now());
        const data = await response.json();
        allChannels = data.channels || [];
        pendingExchanges = data.exchanges || [];
        updateChannelLists();
      } catch (error) {
        console.error("Error loading data:", error);
        // Try localStorage fallback
        const localData = localStorage.getItem('youtubeExchangeData');
        if (localData) {
          const data = JSON.parse(localData);
          allChannels = data.channels || [];
          pendingExchanges = data.exchanges || [];
        }
      }
    }

    // Update data via GitHub Actions
    async function saveData() {
      const payload = {
        channels: allChannels,
        exchanges: pendingExchanges,
        updated: new Date().toISOString()
      };

      try {
        // Trigger GitHub Actions workflow
        const response = await fetch(`https://api.github.com/repos/${REPO}/dispatches`, {
          method: 'POST',
          headers: {
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            event_type: 'update_data',
            client_payload: {
              message: `Update from ${currentUser?.email || 'anonymous'}`,
              data: payload
            }
          })
        });
        
        if (!response.ok) throw new Error('Failed to trigger update');
        console.log("Update triggered successfully");
      } catch (error) {
        console.error("Error triggering update:", error);
        // Fallback to localStorage
        localStorage.setItem('youtubeExchangeData', JSON.stringify(payload));
      }
    }

    // Handle Google login
    function handleLogin(response) {
      console.log("Google login response:", response);
      
      // For demo - in real app you would verify this with backend
      currentUser = {
        name: "You", // Would get from Google profile
        email: "your@email.com",
        channel: ""
      };
      
      document.getElementById('auth-section').style.display = 'none';
      document.getElementById('channel-form').style.display = 'block';
      document.getElementById('username').textContent = currentUser.name;
      
      // Load existing data
      loadData();
    }

    // Register channel
    async function registerChannel() {
      const channelUrl = document.getElementById('channel-url').value.trim();
      
      if (!channelUrl.includes('youtube.com')) {
        alert("Please enter a valid YouTube URL");
        return;
      }
      
      currentUser.channel = channelUrl;
      
      // Add to channels list if not exists
      if (!allChannels.some(c => c.url === channelUrl)) {
        allChannels.push({
          url: channelUrl,
          owner: currentUser.email,
          subscribed: []
        });
      }
      
      await saveData();
      
      // Show dashboard
      document.getElementById('channel-form').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      document.getElementById('user-channel').textContent = channelUrl;
      
      // Load all channels
      updateChannelLists();
    }

    // Update both available and pending channels lists
    function updateChannelLists() {
      const channelsList = document.getElementById('channels-list');
      const pendingList = document.getElementById('pending-list');
      
      channelsList.innerHTML = '';
      pendingList.innerHTML = '';
      
      // Filter available channels
      const availableChannels = allChannels.filter(channel => {
        return channel.url !== currentUser.channel &&
               !channel.subscribed.includes(currentUser.email) &&
               !pendingExchanges.some(ex => 
                 ex.from === currentUser.email && ex.to === channel.owner
               );
      });
      
      // Display available channels
      availableChannels.forEach(channel => {
        const div = document.createElement('div');
        div.className = 'channel';
        div.innerHTML = `
          <div>
            <strong>${channel.url.split('/').pop()}</strong>
            <p>Owner: ${channel.owner}</p>
          </div>
          <button onclick="startExchange('${channel.url}', '${channel.owner}')">
            Exchange Subs
          </button>
        `;
        channelsList.appendChild(div);
      });
      
      // Display pending exchanges
      pendingExchanges.forEach(exchange => {
        const channel = allChannels.find(c => c.owner === exchange.to);
        if (!channel) return;
        
        const div = document.createElement('div');
        div.className = 'channel pending';
        div.innerHTML = `
          <div>
            <strong>${channel.url.split('/').pop()}</strong>
            <p>Waiting for them to subscribe back to you</p>
          </div>
          <button disabled>Pending...</button>
        `;
        pendingList.appendChild(div);
      });
    }

    // Start exchange process
    async function startExchange(channelUrl, channelOwner) {
      if (confirm(`You'll be redirected to subscribe to:\n${channelUrl}\n\nAfter subscribing, they will need to subscribe back to you!`)) {
        // Add to pending exchanges
        pendingExchanges.push({
          from: currentUser.email,
          to: channelOwner,
          started: new Date().toISOString()
        });
        
        // Mark in channels data
        const channel = allChannels.find(c => c.url === channelUrl);
        if (channel) {
          channel.subscribed.push(currentUser.email);
        }
        
        await saveData();
        updateChannelLists();
        
        // Open their channel
        window.open(channelUrl, '_blank');
      }
    }

    // Initialize
    (async function() {
      await loadData();
    })();
  </script>
</body>
        </html>
