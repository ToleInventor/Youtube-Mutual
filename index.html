<!DOCTYPE html>
<html>
<head>
  <title>YouTube Exchange</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* Your existing CSS styles */
    .hidden { display: none; }
    .spinner {
      border: 4px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top: 4px solid #FF0000;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<div id="auth-section" class="box">
  <h2>Welcome to YouTube Exchange</h2>
  <div id="g_id_onload"
       data-client_id="55873258958-126c00b3kq0cjsgeciimqtcieoin8915.apps.googleusercontent.com"
       data-callback="handleLogin">
  </div>
</div>

<div id="loading" class="box hidden">
  <div class="spinner"></div>
  <p>Loading your data...</p>
</div>

<div id="channel-form" class="box hidden">
  <h2>Register Your Channel</h2>
  <p>Enter your YouTube channel URL:</p>
  <input type="text" id="channel-url" placeholder="https://youtube.com/c/YourChannel">
  <button onclick="registerChannel()">Complete Registration</button>
</div>

<div id="dashboard" class="box hidden">
  <h2>Welcome back, <span id="username"></span>!</h2>
  <div class="channel-info">
    <h3>Your Channel:</h3>
    <p id="user-channel"></p>
    <img id="channel-thumbnail" src="" width="80" style="border-radius:50%">
  </div>
  
  <!-- Rest of your dashboard UI -->
</div>

<script>
  const REPO = 'ToleInventor/Youtube-Mutual';
  let currentUser = null;

  // Handle Google login
  async function handleLogin(response) {
    document.getElementById('auth-section').classList.add('hidden');
    document.getElementById('loading').classList.remove('hidden');
    
    // Verify token (in production, verify properly)
    const user = await verifyGoogleToken(response.credential);
    currentUser = user;
    
    // Check if user exists in system
    const userData = await checkUserRegistration(user.email);
    
    if (userData.channel) {
      showDashboard(userData);
    } else {
      showRegistrationForm();
    }
  }

  async function verifyGoogleToken(token) {
    // Simplified - in production verify properly
    const payload = JSON.parse(atob(token.split('.')[1]));
    return {
      name: payload.name || "User",
      email: payload.email,
      picture: payload.picture
    };
  }

  async function checkUserRegistration(email) {
    const data = await loadData();
    const userChannel = data.channels.find(c => c.owner === email);
    return {
      channel: userChannel,
      exchanges: data.exchanges.filter(e => e.from === email || e.to === email)
    };
  }

  async function loadData() {
    const response = await fetch(`https://raw.githubusercontent.com/${REPO}/main/data.json?t=${Date.now()}`);
    return await response.json();
  }

  function showDashboard(userData) {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    
    document.getElementById('username').textContent = currentUser.name;
    document.getElementById('user-channel').textContent = userData.channel.name;
    document.getElementById('channel-thumbnail').src = userData.channel.thumbnail;
    
    // Load other dashboard data...
  }

  function showRegistrationForm() {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('channel-form').classList.remove('hidden');
  }

  async function registerChannel() {
    const channelUrl = document.getElementById('channel-url').value.trim();
    if (!channelUrl.includes('youtube.com')) {
      alert("Please enter a valid YouTube URL");
      return;
    }
    
    // Add channel to data
    const newChannel = {
      url: channelUrl,
      owner: currentUser.email,
      name: `Channel of ${currentUser.name}`,
      thumbnail: currentUser.picture,
      subscribed: [],
      date_registered: new Date().toISOString()
    };
    
    await updateData(data => {
      data.channels.push(newChannel);
      return data;
    });
